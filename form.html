<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Isi Formulir</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
  </style>
</head>
<body class="p-8">

  <div class="max-w-xl mx-auto bg-white p-8 rounded-lg shadow-lg">
    <h1 id="form-title" class="text-2xl font-bold mb-2 text-center">Memuat Formulir...</h1>
    <p id="loading-status" class="text-center text-gray-500 mb-6">Silakan tunggu...</p>

    <form id="dynamic-form" class="space-y-6 hidden">
      <button type="submit" id="submit-btn" class="w-full p-4 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition">
        Kirim Formulir
      </button>
    </form>
    
    <p id="submission-feedback" class="mt-4 text-center font-medium"></p>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAcFRkbZT3PD3BDObS-7T1769uH5Macvd0",
      authDomain: "reystore-support.firebaseapp.com",
      databaseURL: "https://reystore-support-default-rtdb.firebaseio.com",
      projectId: "reystore-support",
      storageBucket: "reystore-support.firebasestorage.app",
      messagingSenderId: "446513200960",
      appId: "1:446513200960:web:cbd40ca4315a8bf47044a5",
      measurementId: "G-YEBFKLREK5"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const params = new URLSearchParams(window.location.search);
    const formId = params.get('id');

    const formTitleEl = document.getElementById('form-title');
    const loadingStatusEl = document.getElementById('loading-status');
    const dynamicFormEl = document.getElementById('dynamic-form');
    const submissionFeedbackEl = document.getElementById('submission-feedback');
    const submitBtn = document.getElementById('submit-btn');

    if (formId) {
      database.ref(`forms/${formId}`).once('value', (snapshot) => {
        const formData = snapshot.val();
        if (formData) {
          formTitleEl.textContent = formData.title || 'Formulir';
          loadingStatusEl.style.display = 'none';
          dynamicFormEl.classList.remove('hidden');

          const formElementsContainer = document.createElement('div');
          (formData.questions || []).forEach(q => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'mb-4';
            const labelEl = document.createElement('label');
            labelEl.className = 'block text-sm font-medium text-gray-700 mb-2';
            labelEl.textContent = q.label;
            questionDiv.appendChild(labelEl);

            let inputEl;
            if (q.type === 'text') {
              inputEl = document.createElement('input');
              inputEl.type = 'text';
              inputEl.name = q.id;
              inputEl.className = 'w-full p-2 border border-gray-300 rounded-lg';
              inputEl.required = true;
            } else if (q.type === 'textarea') {
              inputEl = document.createElement('textarea');
              inputEl.name = q.id;
              inputEl.rows = 4;
              inputEl.className = 'w-full p-2 border border-gray-300 rounded-lg';
              inputEl.required = true;
            } else if (q.type === 'dropdown') {
              inputEl = document.createElement('select');
              inputEl.name = q.id;
              inputEl.className = 'w-full p-2 border border-gray-300 rounded-lg';
              inputEl.required = true;
              const defaultOption = document.createElement('option');
              defaultOption.textContent = 'Pilih...';
              defaultOption.value = '';
              inputEl.appendChild(defaultOption);
              (q.options || []).forEach(optionText => {
                const optionEl = document.createElement('option');
                optionEl.textContent = optionText;
                optionEl.value = optionText;
                inputEl.appendChild(optionEl);
              });
            }
            questionDiv.appendChild(inputEl);
            formElementsContainer.appendChild(questionDiv);
          });
          dynamicFormEl.prepend(formElementsContainer);
        } else {
          formTitleEl.textContent = 'Formulir Tidak Ditemukan';
          loadingStatusEl.textContent = 'ID formulir tidak valid.';
        }
      }).catch(error => {
        formTitleEl.textContent = 'Terjadi Kesalahan';
        loadingStatusEl.textContent = `Error: ${error.message}`;
        console.error(error);
      });
    } else {
      formTitleEl.textContent = 'Formulir Tidak Ditemukan';
      loadingStatusEl.textContent = 'Tidak ada ID formulir di URL.';
    }

    dynamicFormEl.addEventListener('submit', (e) => {
      e.preventDefault();
      const answers = {};
      const formData = new FormData(dynamicFormEl);
      for (const [key, value] of formData.entries()) {
        answers[key] = value;
      }
      const submissionData = { formId, answers, submittedAt: firebase.database.ServerValue.TIMESTAMP };
      submitBtn.textContent = 'Mengirim...';
      submitBtn.disabled = true;

      database.ref('submissions').push(submissionData)
        .then(() => {
          submissionFeedbackEl.textContent = 'Terima kasih, jawabanmu berhasil dikirim!';
          submissionFeedbackEl.className = 'mt-4 text-center font-medium text-green-500';
          dynamicFormEl.reset();
        })
        .catch(error => {
          submissionFeedbackEl.textContent = `Gagal mengirim: ${error.message}`;
          submissionFeedbackEl.className = 'mt-4 text-center font-medium text-red-500';
        })
        .finally(() => {
          submitBtn.textContent = 'Kirim Formulir';
          submitBtn.disabled = false;
        });
    });
  </script>

</body>
</html>
